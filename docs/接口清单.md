# 接口与端口清单（默认 BASE_PORT=9000）

本项目启动后会同时开启 6 个端口：

- HTTP 服务（3 个）：`BASE_PORT`、`BASE_PORT+1`、`BASE_PORT+2`（默认分别为 9000、9001、9002）
- WebSocket 服务（3 个）：`BASE_PORT+3`、`BASE_PORT+4`、`BASE_PORT+5`（默认分别为 9003、9004、9005）

可通过环境变量 `BASE_PORT` 覆盖基础端口，未设置时默认为 9000。

以下列出在默认端口（9000~9005）下，所有可用接口（包含重复 path 的不同端口）。所有 HTTP JSON 响应均为 `application/json; charset=utf-8`。

WebSocket 令牌校验（重要）：
- 静态令牌：`zhongmiao-org-token`
- 校验位置（满足其一即可）：
  - Header：`X-Auth-Token: zhongmiao-org-token`（Node 等非浏览器环境可用）
  - 查询参数：`?token=zhongmiao-org-token`（浏览器原生 WebSocket 请使用该方式，因无法自定义 Header）
- 前端示例：
  - 浏览器：`new WebSocket('ws://localhost:9003/ws/echo?token=zhongmiao-org-token')`
  - Node（ws）：
    ```js
    new (require('ws'))('ws://localhost:9003/ws/echo', { headers: { 'X-Auth-Token': 'zhongmiao-org-token' } })
    ```

WS 事件键名规则（不同服务多样化）：
- ws-echo：事件键名为 `type`
- ws-ticker：事件键名为 `action`
- ws-timeline：事件键名为 `event`

---

## 9000（user-service）

- GET `http://localhost:9000/`
  - 返回：`{"service":"user-service","port":9000,"message":"Upstream running"}`

- GET `http://localhost:9000/health`
  - 返回：`{"status":"ok"}`

- GET `http://localhost:9000/status/{code}` 例：`/status/200`
  - HTTP 状态码：`{code}`（无效 code 则为 400）
  - 返回：`{"status":{code}}`

- GET `http://localhost:9000/delay/{ms}` 例：`/delay/150`
  - 服务端延迟 `{ms}` 毫秒后返回
  - 返回：`{"delayedMs":{ms}}`

- GET `http://localhost:9000/headers`
  - 返回：`{"headers":{...}}`（仅回显存在的请求头：Authorization、Content-Type、User-Agent、X-Request-Id）

- GET `http://localhost:9000/cookies`
  - 返回：`{"cookies":{ "<name>": "<value>", ... }}`

- GET `http://localhost:9000/large?size=<n>`（默认 65536 字节，最大 2MB）
  - 返回：`{"size":<n>, "data":"<长度为 n 的字符串>"}`

- ANY `http://localhost:9000/echo`
  - 返回：`{"method":"<HTTP 方法>","path":"/echo","query":"<原始查询串>","length":<请求体长度>,"body":"<请求体字符串>"}`

- RESTful 集合 `http://localhost:9000/rest/items`
  - GET 列表：返回 `{"items":[...]}`
  - POST 创建：请求体任意 JSON，返回 `201` 和新对象（包含 `id`），并设置 `Location: /rest/items/{id}`
  - OPTIONS：返回 `204`，并带 `Allow: GET,POST,OPTIONS`

- RESTful 单项 `http://localhost:9000/rest/items/{id}`
  - GET 获取：返回对象 JSON
  - PUT 全量更新：请求体为完整对象，返回更新后对象
  - PATCH 部分更新：请求体为变更字段，返回更新后对象
  - DELETE 删除：返回 `204 No Content`
  - OPTIONS：返回 `204`，并带 `Allow: GET,PUT,PATCH,DELETE,OPTIONS`

- GET `http://localhost:9000/api/user/info`
  - 返回：来自静态文件 `assets/user/info.json`（若不存在则返回内置默认值）

- GET `http://localhost:9000/api/posts`
  - 返回：来自静态文件 `assets/user/posts.json`（若不存在则返回内置示例）

---

## 9001（order-service）

- GET `http://localhost:9001/`
  - 返回：`{"service":"order-service","port":9001,"message":"Upstream running"}`

- GET `http://localhost:9001/health`
  - 返回：`{"status":"ok"}`

- GET `http://localhost:9001/status/{code}` 例：`/status/200`
  - HTTP 状态码：`{code}`（无效 code 则为 400）
  - 返回：`{"status":{code}}`

- GET `http://localhost:9001/delay/{ms}` 例：`/delay/150`
  - 返回：`{"delayedMs":{ms}}`

- GET `http://localhost:9001/headers`
  - 返回：`{"headers":{...}}`

- GET `http://localhost:9001/cookies`
  - 返回：`{"cookies":{...}}`

- GET `http://localhost:9001/large?size=<n>`
  - 返回：`{"size":<n>, "data":"..."}`

- ANY `http://localhost:9001/echo`
  - 返回：`{"method":...,"path":"/echo","query":...,"length":...,"body":...}`

- RESTful 集合 `http://localhost:9001/rest/items`
  - GET/POST/OPTIONS 同 9000 端口

- RESTful 单项 `http://localhost:9001/rest/items/{id}`
  - GET/PUT/PATCH/DELETE/OPTIONS 同 9000 端口

- GET `http://localhost:9001/order-api/orders`
  - 返回：来自静态文件 `assets/order/orders.json`（若不存在则返回内置示例）

- POST `http://localhost:9001/order-api/orders`
  - 请求体：任意 JSON（例如：`{"amount":199}`）
  - HTTP 状态码：`201`
  - 返回：`{"code":0,"data":{...原请求体...,"id":<0-99999 的随机整数>}}`

- GET `http://localhost:9001/order-api/order/{id}/submit`
  - 返回：`{"message":"submit ok"}`（不满足 `/submit` 结尾将返回 404）

---

## 9002（payment-service）

- GET `http://localhost:9002/`
  - 返回：`{"service":"payment-service","port":9002,"message":"Upstream running"}`

- GET `http://localhost:9002/health`
  - 返回：`{"status":"ok"}`

- GET `http://localhost:9002/status/{code}`
  - HTTP 状态码：`{code}`（无效 code 则为 400）
  - 返回：`{"status":{code}}`

- GET `http://localhost:9002/delay/{ms}`
  - 返回：`{"delayedMs":{ms}}`

- GET `http://localhost:9002/headers`
  - 返回：`{"headers":{...}}`

- GET `http://localhost:9002/cookies`
  - 返回：`{"cookies":{...}}`

- GET `http://localhost:9002/large?size=<n>`
  - 返回：`{"size":<n>, "data":"..."}`

- ANY `http://localhost:9002/echo`
  - 返回：`{"method":...,"path":"/echo",...}`

- RESTful 集合 `http://localhost:9002/rest/items`
  - GET/POST/OPTIONS 同 9000 端口

- RESTful 单项 `http://localhost:9002/rest/items/{id}`
  - GET/PUT/PATCH/DELETE/OPTIONS 同 9000 端口

- GET `http://localhost:9002/pay-api/checkout`
  - 约 150ms 后返回：来自静态文件 `assets/payment/checkout.json`（若不存在则返回内置示例）

---

## 9003（ws-echo）

- GET `http://localhost:9003/`
  - 返回：`{"service":"ws-echo","port":9003}`

- WS `ws://localhost:9003/ws/echo?token=zhongmiao-org-token`
  - 行为：接收到的消息原样回显（缺少令牌将 401，不会升级）

- WS `ws://localhost:9003/ws/food/user?token=zhongmiao-org-token[&interval=ms]`
  - 行为：模拟用户侧外卖订单流程，事件字段名为 `type`
  - 数据来源：`assets/ws/food_user.json`（如不存在则使用内置默认）
  - 完整示例（用户侧序列，JSON 数组）：
    ```json
    [
      {"type":"order_accepted","orderId":"123456","riderId":"rider_888","riderName":"张师傅","riderPhone":"138****1234","estimatedArrival":"19:30"},
      {"type":"order_picked_up","orderId":"123456","timestamp":1621234567890},
      {"type":"rider_location_update","orderId":"123456","location":{"lat":39.9042,"lng":116.4074}},
      {"type":"rider_location_update","orderId":"123456","location":{"lat":39.905,"lng":116.408}},
      {"type":"order_delivered","orderId":"123456","timestamp":1621234667890},
      {"type":"order_cancelled","orderId":"123456","reason":"用户取消"}
    ]
    ```

- WS `ws://localhost:9003/ws/food/merchant?token=zhongmiao-org-token[&interval=ms]`
  - 行为：模拟商家侧外卖通知，事件字段名为 `type`
  - 数据来源：`assets/ws/food_merchant.json`
  - 商家侧序列（JSON 数组）：
    ```json
    [
      {"type":"new_order","orderId":"123456","items":[{"name":"红烧牛肉面","qty":2}],"userAddress":"XX路XX号","userNote":"不要香菜"},
      {"type":"order_cancelled","orderId":"123456","reason":"商家拒单"}
    ]
    ```

---

## 9004（ws-ticker）

- GET `http://localhost:9004/`
  - 返回：`{"service":"ws-ticker","port":9004}`

- WS `ws://localhost:9004/ws/ticker?interval=<ms>&token=zhongmiao-org-token`（默认 1000ms）
  - 行为：按指定间隔发送文本消息：`tick 1`、`tick 2`、...

- WS `ws://localhost:9004/ws/food/user?token=zhongmiao-org-token[&interval=ms]`
  - 行为：模拟用户侧外卖订单流程，事件字段名为 `action`
  - 数据来源：`assets/ws/food_user.json`（会将 `type` 字段自动重命名为 `action`）
  - 示例（键名转换后，单对象）：
    ```json
    {"action":"order_accepted","orderId":"123456","riderId":"rider_888"}
    ```

- WS `ws://localhost:9004/ws/food/merchant?token=zhongmiao-org-token[&interval=ms]`
  - 行为：模拟商家侧外卖通知，事件字段名为 `action`
  - 数据来源：`assets/ws/food_merchant.json`

---

## 9005（ws-timeline）

- GET `http://localhost:9005/`
  - 返回：`{"service":"ws-timeline","port":9005}`

- WS `ws://localhost:9005/ws/timeline?token=zhongmiao-org-token`
  - 行为：依次发送 `assets/ws/timeline.json` 中的字符串项（若文件不存在则为 `hello/processing/done`），随后正常关闭连接

- WS `ws://localhost:9005/ws/food/user?token=zhongmiao-org-token[&interval=ms]`
  - 行为：模拟用户侧外卖订单流程，事件字段名为 `event`
  - 数据来源：`assets/ws/food_user.json`（会将 `type` 字段自动重命名为 `event`）
  - 示例（键名转换后，单对象）：
    ```json
    {"event":"order_accepted","orderId":"123456","riderId":"rider_888"}
    ```

- WS `ws://localhost:9005/ws/food/merchant?token=zhongmiao-org-token[&interval=ms]`
  - 行为：模拟商家侧外卖通知，事件字段名为 `event`
  - 数据来源：`assets/ws/food_merchant.json`

---

## 备注

- 三个 HTTP 服务（9000/9001/9002）共享一组通用调试接口（`/`、`/health`、`/status/{code}`、`/delay/{ms}`、`/headers`、`/cookies`、`/large`、`/echo`），因此 path 会在不同端口重复出现。
- 如需修改基础端口范围，请在启动时设置环境变量：`BASE_PORT=<起始端口>`。
- 静态数据资源目录：默认 `assets/`，可通过 `ASSETS_DIR` 环境变量覆盖。
  - user/info.json：用户信息
  - user/posts.json：帖子列表
  - order/orders.json：订单列表
  - payment/checkout.json：支付结果
  - rest/items.json：用于 RESTful 示例的初始数据种子（服务启动后会加载到内存，后续 PUT/PATCH/DELETE 仅影响内存）
  - ws/timeline.json：WS 时间线消息数组（字符串）
